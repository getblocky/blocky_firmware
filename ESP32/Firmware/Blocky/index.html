<!doctype html>
<html>
   <head>
      <meta charset=utf-8>
      <meta name=viewport content='width=380'>
      <title>Connect Blocky to you WiFi</title>
      <script type=text/javascript>
			function loadAPs() {
				var a = new XMLHttpRequest();
				a.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						var b = JSON.parse(this.responseText);
						for (var d in b) {
							var c = document.createElement("option");
							c.text = b[d].ssid;
							c.value = b[d].ssid;
							document.getElementById("apslist").options.add(c)
						}
					}
					document.getElementById("loaderDiv").style.visibility = "hidden"
				};
				a.open("GET", "/aplist", true);
				a.send()
			}
			var checkStatusTimer = null;

			function checkStatus() {
				var a = new XMLHttpRequest();
				a.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						if (this.responseText == "OK") {
							clearInterval(checkStatusTimer);
							document.getElementById("loaderDiv").style.visibility = "hidden";
							document.getElementById("loaderLabel").innerText = "WIFI setup is done. Your Blocky will reboot. You now can close this page.";
							document.getElementsByName("ssid")[0].style.display = "none";
							document.getElementsByName("password")[0].style.display = "none";
							document.getElementsByName("auth_key")[0].style.display = "none";
							document.getElementsByName("device_name")[0].style.display = "none";
							document.getElementById("submit").style.display = "none"
						} else {
							if (this.responseText == "Failed") {
								clearInterval(checkStatusTimer);
								document.getElementById("form").disabled = false;
								document.getElementById("loaderDiv").style.visibility = "hidden";
								document.getElementById("loaderLabel").innerText = "Failed to connect. Try again please."
							}
						}
					}
				};
				a.open("GET", "/status", true);
				a.send()
			}

			function save() {
				document.getElementById("form").disabled = false;
				document.getElementById("loaderDiv").style.visibility = "visible";
				document.getElementById("loaderLabel").innerText = "Connecting to the selected WIFI network";
				var a = new XMLHttpRequest();
				a.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						checkStatusTimer = setInterval(checkStatus, 1000)
					}
				};
				a.open("POST", "/save", true);
				a.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
				a.send(JSON.stringify({
					ssid: document.getElementsByName("ssid")[0].value,
					password: document.getElementsByName("password")[0].value,
					auth_key: document.getElementsByName("auth_key")[0].value,
					deviceName: document.getElementsByName("deviceName")[0].value
				}))
			};
	  </script>
   </head>
   <body onload=loadAPs()>
      <div>
         <form id=form>
            <fieldset>
               <h2 class=fs-title>Blocky Configuration</h2>
               <h3 class=fs-subtitle id=loaderLabel>Select your Wi-Fi network</h3>
               <select id=apslist name=ssid placeholder='WiFi Name'>
                  <option value></option>
               </select>
               <input type=password name=password placeholder=Password />
               <input type=text autocorrect=off autocapitalize=none name=auth_key placeholder='Authentication Key' />
               <input type=text autocorrect=off autocapitalize=none name=deviceName placeholder='Set name for this Blocky' />
               <input type=button id=submit class='submit action-button' value=Submit onclick=save() />
            </fieldset>
         </form>
         <div class=loader id=loaderDiv style=visibility:visible></div>
      </div>
   </body>
</html>